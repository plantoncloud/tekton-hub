apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: build-kustomize-directory
  namespace: planton-cloud-pipelines
spec:
  description: >
    A Pipeline to build kustomize directory and generate manifests.
  params:
    - name: git-url
      type: string
      description: "The Git URL to clone"
    - name: git-revision
      type: string
      description: "Git revision to checkout"
      default: "main"
    - name: kustomize-manifests-config-map-name
      type: string
      description: "Name of the config-map to store service manifests generated by kustomize"
    - name: project-root
      type: string
      description: "Relative path to the project's root inside the cloned repo"
      default: "."
    - name: kustomize-base-directory
      type: string
      description: "Relative path to the kustomize base directory inside project root"
      default: ""
    - name: owner-identifier-label-key
      type: string
      description: Optional owner identifier label key to add to the ConfigMap
      default: ""
    - name: owner-identifier-label-value
      type: string
      description: Optional owner identifier label value
      default: ""

  workspaces:
    - name: source
      description: "Workspace where source code is cloned"

  tasks:
    ########################################################################
    # Clone source from Git
    ########################################################################
    - name: git-checkout
      taskRef:
        resolver: hub
        params:
          - name: type
            value: tekton
          - name: kind
            value: task
          - name: name
            value: git-clone
          - name: version
            value: "0.9"
      params:
        - name: url
          value: "$(params.git-url)"
        - name: revision
          value: "$(params.git-revision)"
        - name: deleteExisting
          value: "true"
        - name: gitInitImage
          value: "ghcr.io/tektoncd/github.com/tektoncd/pipeline/cmd/git-init:v0.45.0"
      workspaces:
        - name: output
          workspace: source

    ########################################################################
    # Kustomize build
    ########################################################################
    - name: kustomize-build
      runAfter:
        - git-checkout
      taskRef:
        resolver: git
        params:
          - name: url
            value: "https://github.com/plantoncloud/tekton-hub.git"
          - name: revision
            value: "main"
          - name: pathInRepo
            value: "tasks/kustomize-build.yaml"
      params:
        - name: config-map-name
          value: "$(params.kustomize-manifests-config-map-name)"
        - name: config-map-namespace
          value: "planton-cloud-pipelines"
        - name: project-root
          value: "$(params.project-root)"
        - name: kustomize-base-directory
          value: "$(params.kustomize-base-directory)"
        - name: owner-identifier-label-key
          value: "$(params.owner-identifier-label-key)"
        - name: owner-identifier-label-value
          value: "$(params.owner-identifier-label-value)"
      workspaces:
        - name: source
          workspace: source
