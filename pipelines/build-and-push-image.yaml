apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: build-and-push-image-local
  namespace: planton-cloud-pipelines
spec:
  params:
    - name: git-url
      type: string
      description: "The Git URL to clone"
    - name: git-revision
      type: string
      description: "Git revision to checkout"
      default: "main"
    - name: setup-package-credentials
      type: string
      description: "Set to 'true' to run setup-package-credentials task"
      default: "false"
    - name: image-name
      type: string
      description: "The final image name to be built/pushed"
    - name: kustomize-manifests-config-map-name
      type: string
      description: "Name of the config-map to store service manifests generated by kustomize"
  workspaces:
    - name: source
      description: "Workspace that stores source code & build artifacts"
    - name: package-credentials
      description: "Workspace that stores package-credentials required for build"

  tasks:
    - name: git-checkout
      taskRef:
        resolver: hub
        params:
          - name: type
            value: tekton
          - name: kind
            value: task
          - name: name
            value: git-clone
          - name: version
            value: "0.9"
      params:
        - name: url
          value: "$(params.git-url)"
        - name: revision
          value: "$(params.git-revision)"
        - name: deleteExisting
          value: "true"
      workspaces:
        - name: output
          workspace: source

    - name: setup-package-credentials
      when:
        - input: "$(params.setup-package-credentials)"
          operator: in
          values: ["true"]
      runAfter:
        - git-checkout
      taskSpec:
        workspaces:
          - name: source
          - name: package-credentials
        steps:
          - name: copy
            image: alpine:3
            script: |
              mkdir -p /workspace/source/.package-credentials
              cp /workspace/package-credentials/* /workspace/source/.package-credentials/ || true
      workspaces:
        - name: source
        - name: package-credentials

    - name: build-image
      runAfter:
        - setup-package-credentials
      taskRef:
        name: buildpacks-phases
      params:
        - name: BUILDER_IMAGE
          value: "paketobuildpacks/builder-jammy-base"
        - name: IMAGE
          value: "$(params.image-name)"
        - name: SOURCE_SUBPATH
          value: ""
        - name: PROCESS_TYPE
          value: "web"
        - name: BP_JVM_VERSION
          value: "21"
      workspaces:
        - name: source
          workspace: source

    - name: kustomize-build
      runAfter:
        - git-checkout
      taskRef:
        resolver: git
        params:
          - name: url
            value: "https://github.com/plantoncloud/tekton-hub.git"
          - name: revision
            value: "main"
          - name: pathInRepo
            value: "tasks/kustomize-build.yaml"
      params:
        - name: configMapName
          value: "$(params.kustomize-manifests-config-map-name)"
        - name: configMapNamespace
          value: "planton-cloud-pipelines"
      workspaces:
        - name: source
          workspace: source
